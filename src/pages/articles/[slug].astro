---
// @ts-nocheck
import Layout from '@/layouts/Layout.astro';
import BlogPostWrapper from '@/components/BlogPostWrapper';
import { fetchBlogPostsForBuild } from '@/services/wordpress';

// Generate static paths for all blog posts (build time)
export async function getStaticPaths() {
  try {
    const posts = await fetchBlogPostsForBuild();
    
    if (posts.length === 0) {
      console.warn('No blog posts found for static generation. Using fallback.');
      // Return at least the hello-world post as fallback
      return [
        {
          params: { slug: 'hello-world' },
        }
      ];
    }
    
    return posts.map((post) => ({
      params: { slug: post.slug },
    }));
  } catch (error) {
    console.error('Error fetching blog posts for static paths:', error);
    // Return fallback paths
    return [
      {
        params: { slug: 'hello-world' },
      }
    ];
  }
}

const { slug } = Astro.params;

// Fetch individual post data from WordPress
let post = null;
try {
  const response = await fetch(
    `https://avyra.co.in/blog/wp-json/wp/v2/posts?_embed&slug=${slug}`,
    {
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'Avyra-Blog-Client/1.0',
      },
    }
  );
  
  if (response.ok) {
    const posts = await response.json();
    if (posts.length > 0) {
      // Transform the post
      const wpPost = posts[0];
      post = {
        id: wpPost.id.toString(),
        slug: wpPost.slug,
        title: wpPost.title.rendered,
        excerpt: wpPost.excerpt.rendered.replace(/<[^>]*>/g, '').trim(),
        content: wpPost.content.rendered,
        image: wpPost._embedded?.['wp:featuredmedia']?.[0]?.source_url || '/placeholder.svg',
        date: new Date(wpPost.date).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
        }),
        category: wpPost._embedded?.['wp:term']?.[0]?.[0]?.name || 'Uncategorized',
        readTime: `${Math.ceil(wpPost.content.rendered.replace(/<[^>]*>/g, '').split(/\s+/).length / 200)} min read`,
      };
    }
  }
} catch (error) {
  console.error(`Error fetching post ${slug}:`, error);
}

const title = post ? `${post.title} | AVYRA Blog` : 'Blog Post | AVYRA';
const description = post?.excerpt || 'Read expert insights on kitchen design, wardrobes, and home interiors from AVYRA.';
const keywords = 'kitchen design, wardrobe design, home interior, SS 304 stainless steel, modular kitchen, interior design blog';
const canonicalUrl = post ? `https://www.avyra.co.in/articles/${slug}` : 'https://www.avyra.co.in/articles';
---

<Layout 
  title={title} 
  description={description}
  keywords={keywords}
  canonicalUrl={canonicalUrl}
>
  {post ? (
    <BlogPostWrapper client:load post={post} />
  ) : (
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-foreground mb-4">Post Not Found</h1>
        <p class="text-foreground/70 mb-8">The blog post you're looking for doesn't exist.</p>
        <a href="/articles" class="inline-block px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90">
          Back to Blog
        </a>
      </div>
    </div>
  )}
</Layout>

